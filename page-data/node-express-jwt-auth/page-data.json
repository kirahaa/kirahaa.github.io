{"componentChunkName":"component---src-templates-blog-post-js","path":"/node-express-jwt-auth/","result":{"data":{"site":{"siteMetadata":{"title":"Kirahaa"}},"markdownRemark":{"id":"b54a6070-dbd7-5ce7-ac9c-21d9aad67db7","excerpt":"Node.js와 Express, Mongodb를 이용한 JWT 토큰 기반 인증 시스템을 구현 한 뒤, AWS ec2를 통해 배포한 내용을 정리하였습니다. 1. 프로젝트 생성 및 설정하기 새로운 디렉토리를 만든 후, package.json 파일을 다음과 같이 설정해주고, npm…","html":"<blockquote>\n<p>Node.js와 Express, Mongodb를 이용한 JWT 토큰 기반 인증 시스템을 구현 한 뒤, AWS ec2를 통해 배포한 내용을 정리하였습니다.</p>\n</blockquote>\n<hr>\n<h2>1. 프로젝트 생성 및 설정하기</h2>\n<p>새로운 디렉토리를 만든 후, package.json 파일을 다음과 같이 설정해주고, <code>npm install</code> 명령어를 통해 프로젝트에 필요한 모듈을 설치해 줍니다.</p>\n<deckgo-highlight-code language=\"json\"  >\n          <code slot=\"code\">// package.json\r\n{\r\n  &quot;name&quot;: &quot;express-jwt-auth&quot;,\r\n  &quot;version&quot;: &quot;1.0.0&quot;,\r\n  &quot;description&quot;: &quot;auth with express jwt&quot;,\r\n  &quot;main&quot;: &quot;index.js&quot;,\r\n  &quot;dependencies&quot;: {\r\n    &quot;bcrypt&quot;: &quot;^5.0.0&quot;,\r\n    &quot;cookie-parser&quot;: &quot;^1.4.5&quot;,\r\n    &quot;ejs&quot;: &quot;^3.1.3&quot;,\r\n    &quot;express&quot;: &quot;^4.17.1&quot;,\r\n    &quot;jsonwebtoken&quot;: &quot;^8.5.1&quot;,\r\n    &quot;mongoose&quot;: &quot;^5.9.23&quot;,\r\n    &quot;validator&quot;: &quot;^13.1.1&quot;\r\n  },\r\n  &quot;scripts&quot;: {\r\n    &quot;start&quot;: &quot;node app.js&quot;,\r\n    &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;\r\n  },\r\n  &quot;keywords&quot;: [\r\n    &quot;auth&quot;,\r\n    &quot;express&quot;,\r\n    &quot;jwt&quot;\r\n  ],\r\n  &quot;author&quot;: &quot;hayeong&quot;,\r\n  &quot;license&quot;: &quot;ISC&quot;\r\n}</code>\n        </deckgo-highlight-code>\n<h3>디렉토리 구조</h3>\n<p>프로젝트에서 사용할 디렉토리 구조는 다음과 같습니다.\r\n페이지 템플릿은 <code>ejs</code>를 사용하였습니다.</p>\n<deckgo-highlight-code   >\n          <code slot=\"code\">├─ .gitignore\r\n├─ README.md\r\n├─ app.js\r\n├─ config.example.js\r\n├─ controllers\r\n│  └─ authController.js\r\n├─ middleware\r\n│  └─ authMiddleware.js\r\n├─ models\r\n│  └─ User.js\r\n├─ package.json\r\n├─ public\r\n│  └─ style.css\r\n├─ routes\r\n│  └─ authRoutes.js\r\n└─ views\r\n   ├─ detail.ejs\r\n   ├─ home.ejs\r\n   ├─ login.ejs\r\n   ├─ partials\r\n   │  ├─ footer.ejs\r\n   │  └─ header.ejs\r\n   └─ signup.ejs</code>\n        </deckgo-highlight-code>\n<p>©generated by <a href=\"https://woochanleee.github.io/project-tree-generator\">Project Tree Generator</a></p>\n<h3>app.js 세팅하기</h3>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// app.js\r\nconst express = require(&#39;express&#39;);\r\nconst mongoose = require(&#39;mongoose&#39;);\r\n\r\nconst config = require(&#39;./config&#39;)\r\n\r\nconst app = express();\r\n\r\n// middleware\r\napp.use(express.static(&#39;public&#39;));\r\n\r\n// view engine\r\napp.set(&#39;view engine&#39;, &#39;ejs&#39;);\r\n\r\nmongoose.connect(config.mongodbUri)\r\nconst db = mongoose.connection\r\ndb.on(&#39;error&#39;, console.error)\r\ndb.once(&#39;open&#39;, ()=&gt;{\r\n    console.log(&#39;connected to mongodb server&#39;)\r\n    app.listen(3000)\r\n})\r\n\r\n// routes\r\napp.get(&#39;/&#39;, (req, res) =&gt; res.render(&#39;home&#39;));</code>\n        </deckgo-highlight-code>\n<p><code>config.js</code> 파일은 프로젝트에서 사용할 MongoDB 서버의 정보와, JWT 토큰을 만들 때 사용될 <code>secret</code> 키의 정보를 지니고 있습니다.</p>\n<p>보안에 관련된 정보는 따로 파일에 분리하여 관리하는 것이 좋습니다.\r\ngithub 저장소에도 <code>config.js</code> 파일은 <code>.gitignore</code>에 추가해서 커밋이 되지 않도록 설정합니다.\r\n예제 정보가 적혀있는 <code>config.example.js</code> 파일의 이름을 <code>config.js</code>로 수정하고 사용합니다.\r\n설정 파일을 작성하기 전에, MongoDB 서버를 만들어 봅시다.</p>\n<h2>2. MongoDB 준비</h2>\n<p><a href=\"https://www.mongodb.com/\">MongoDB 홈페이지</a>에 들어가서 회원가입을 해 줍니다.<br/>\r\n새로운 프로젝트를 만들고 새로운 클러스터를 만듭니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f2c905606f20f08dad165fad974c1fa9/9caaa/mongodb_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABTklEQVR42oWS3W4VIRSF5/2fxBfwAbzyRi+MNyYmtqYxaU87TGf42xvYfAZOzrGapi6yMgOEzbeAZYuemDJpuAheEiqClkKzRv9P01rIRUkiiCrL/e54OnZa7/zcPD/czmlPBMlkVXrvbxvOto41Y/m+3nPrHatEnD9w3vPod9wgL8JbGgWHbtcH3n36wMebbyynzXHkSLVGbUapDVWdkYdHjOFa65XqgjWohn49r7z/+pkvdzcsj84RUqJZRWsnqhEl4WO8+jzf/qZ70QyjtI4ZLA/bOgn/XfBSpVZ8zPiQiClhZvRX4lvvI/JGzGlGfk3NDCmVI1V8UkSU1ux6fn+Iz0WXk3Nsxz4pQjpHjHncsHCEMPuicnbRSXh4jw+BmIUjpvkd64eXp23jOQZqq/MtjfMahUJO+BTn/9jgstEYv4xFUXxWguh8j7U1fgN2Yb6VbYCypwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"make new cluster in mongodb\"\n        title=\"\"\n        src=\"/static/f2c905606f20f08dad165fad974c1fa9/984b6/mongodb_1.png\"\n        srcset=\"/static/f2c905606f20f08dad165fad974c1fa9/4d6f2/mongodb_1.png 158w,\n/static/f2c905606f20f08dad165fad974c1fa9/3c1ae/mongodb_1.png 315w,\n/static/f2c905606f20f08dad165fad974c1fa9/984b6/mongodb_1.png 630w,\n/static/f2c905606f20f08dad165fad974c1fa9/e7d8e/mongodb_1.png 945w,\n/static/f2c905606f20f08dad165fad974c1fa9/58c38/mongodb_1.png 1260w,\n/static/f2c905606f20f08dad165fad974c1fa9/9caaa/mongodb_1.png 2874w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>저는 <code>Project 0</code>의 <code>myCluster</code>란 이름의 클러스터를 만들어 주었습니다.</p>\n<h3>데이터 베이스 만들기</h3>\n<p><strong>Browse Collections > add my own data</strong>에서 새로운 데이터 베이스를 생성합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0fce7eaf88640a4114d10bcb5b96e403/f621c/mongodb_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACAUlEQVR42n2SS2sTURiG8y8FE5smk3vakHYyk7lP0napuFaKUSuohbSQpRsX7rSCWkttWkQkVVDT2NDQC9M88p20RUU8cJgzw5z3e28xzfTQDI9s3UfOGdMnVw/IWyEFu/HfLf9kzYBsPSBj+JS9RWJp3aVgNZg2fOK6S9oISNcCNMMnL8B2qC7KkH8NKl48s6bPjAAmdBvN9NWe0h1Shk9yzuH28gPe7+zy6u0mr99tsfmhS/fjJ27eaZHSHYpOU7ETZqJQq3mU3UViSd1RYDJdZBecBlNVi0drHUZHI/r9A06Oj4mic2S1VteIVwxKTvOKtex0zVXfYpmaR74eKu9S8w5azeVGxWRlrcPXwYjewZDh2ZgfRyecKcB1pqp1Sm7zSnbG8EhWLYp2c+LhBFDCcZVHcuFhu0OvP2Tvy3f6o1MOTyMiYPlJm+szNXLK1/CCaaiIzHhLxLQLhmnTI2cHlL0FJXml3eFwOORzb5+DwYAoipTke0/bJGYNFUbODIhXTRJzFtNzNiVngVh63lUTLtMruQuKoXgo63w8hjF8+zng5f4u91fXiSvAJnkz4NqsTqJqkTXDScoCKAwv/RAJkqKkvNXd483WNpvbO7zY2ODx82fcuttSbC57WLKbE7b1YCJZaMvL36WVskodpBZSj4IVUvGWlJo/yv1byYXhLw/sDdyHZaEEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"make database in mongodb\"\n        title=\"\"\n        src=\"/static/0fce7eaf88640a4114d10bcb5b96e403/984b6/mongodb_2.png\"\n        srcset=\"/static/0fce7eaf88640a4114d10bcb5b96e403/4d6f2/mongodb_2.png 158w,\n/static/0fce7eaf88640a4114d10bcb5b96e403/3c1ae/mongodb_2.png 315w,\n/static/0fce7eaf88640a4114d10bcb5b96e403/984b6/mongodb_2.png 630w,\n/static/0fce7eaf88640a4114d10bcb5b96e403/e7d8e/mongodb_2.png 945w,\n/static/0fce7eaf88640a4114d10bcb5b96e403/58c38/mongodb_2.png 1260w,\n/static/0fce7eaf88640a4114d10bcb5b96e403/f621c/mongodb_2.png 2878w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>저는 데이터 베이스 이름을 <code>node-auth</code>로 설정하고, collection 이름을 <code>users</code>로 설정하였습니다.<br/>\r\n설정이 끝나면 <strong>Connect > Connect to your application > Drivers</strong> 해당 데이터 베이스에 연결하면 하단에 <strong>application code</strong>가 나옵니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a76ab49290854c5fad78ba9fdfb20274/a58ca/mongodb_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.89873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACGUlEQVR42mWSyW4TQRRF+/tYsWCD2KCwQMSZbHe7J/fk+HdYAd6Q4HbyIYgkKHFit93ueTyoKyRE4klPqnoqnbr36Uq6YWCYJrZtM5CHfJ3NuH9YcXV1za+ra5bLe7abDZtgQ7Bei16vVkRRxGw2Q1U1LNvGMAwc10EaqCMUXcPxPD70DjnzF3R1F2+Iy5y2bYnrgrDMxLy7Z2UpzovFAk3TmEwmTFyP6ekU6WikcKJraLbFwfERc98nTBJ+3txwfXtHsA3Jq5K0yKmbhqZpSPNcAH3fxzQMjpQhr/fe8bF/iKSoKrpp4noesqww9xckaS5s3y0fiKKYsiyFsqfqoE8KDV1nZOq8P9xnoKlII1UTO3Rdl+PBkPP5gqZtyfOcXZxQlBV1U1PV9TPoJVBVVRzXZWw5nHaWZXX0qND12O/1+H52xnYX8fv2ll0cU1YVnbjO7pPKl0BZlrEsG8uy8CYekjzqLI/xPI9Xb9/w+dsX8XgbJ2RFSdm0VE0rVFed0qamqMrnHWqajuN6jC0bbzJBGsgKqhi6fDrocT73SUtYBhHrMGEdpgRhQpbl/+3wx9znpC9jjC3M8ViAJU3XheUOOBgMWVxckBUF62BDGEXESUKapsRpSl4UwnpVV3+Bc2RFETnsLE+nU6Qu2KY1xnYc+v0+F5eXFG3Dchuw3e2Is4wwT0iyTHT3WZT9y6GuP+ZQ0w329g/4A2A1hlEen3jlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Connect to cluster in mongodb\"\n        title=\"\"\n        src=\"/static/a76ab49290854c5fad78ba9fdfb20274/984b6/mongodb_3.png\"\n        srcset=\"/static/a76ab49290854c5fad78ba9fdfb20274/4d6f2/mongodb_3.png 158w,\n/static/a76ab49290854c5fad78ba9fdfb20274/3c1ae/mongodb_3.png 315w,\n/static/a76ab49290854c5fad78ba9fdfb20274/984b6/mongodb_3.png 630w,\n/static/a76ab49290854c5fad78ba9fdfb20274/e7d8e/mongodb_3.png 945w,\n/static/a76ab49290854c5fad78ba9fdfb20274/58c38/mongodb_3.png 1260w,\n/static/a76ab49290854c5fad78ba9fdfb20274/a58ca/mongodb_3.png 2876w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p><strong>application code 예시</strong></p>\n<p>mongodb+srv://&#x3C;본인 아이디>:&#x3C;패스워드>@mycluster.likcia7.mongodb.net/?retryWrites=true&#x26;w=majority</p>\n</blockquote>\n<h2>3. MongoDB 연결하기</h2>\n<h3>config.js 세팅하기</h3>\n<p>위에서 생성한 <strong>application code</strong>를 복사 붙여넣기 해 줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">module.exports = {\r\n  &#39;secret&#39;: &#39;SeCrEtKeYfOrHaShInG&#39;,\r\n  &#39;mongodbUri&#39;: &#39;mongodb+srv://&lt;본인 아이디&gt;:&lt;패스워드&gt;@mycluster.likcia7.mongodb.net/?retryWrites=true&amp;w=majority&#39;\r\n}</code>\n        </deckgo-highlight-code>\n<p><code>secret</code> 키는 이후에 JWT 토큰을 검증하는 서명 부분에 사용할 비밀 키입니다. 보안에 연관된 정보들은 config.js 파일에 보관해 줍니다.</p>\n<p>여기까지 코드작성이 완료되었다면, 터미널에서 <code>node app.js</code>를 입력하여 서버를 실행할 수 있습니다.</p>\n<deckgo-highlight-code language=\"shell\"  >\n          <code slot=\"code\">&gt; node app.js\r\n\r\nconnected to mongodb server // 이렇게 뜨면 성공! 🎉</code>\n        </deckgo-highlight-code>\n<h2>4. 본격 API 만들기</h2>\n<h3>Auth Routes</h3>\n<p>인증에 관련된 라우터를 구성해 줍니다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">route</th>\n<th align=\"left\">request</th>\n<th align=\"right\">description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><strong>/signup</strong></td>\n<td align=\"left\">GET</td>\n<td align=\"right\">sign up page</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>/login</strong></td>\n<td align=\"left\">GET</td>\n<td align=\"right\">login page</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>/signup</strong></td>\n<td align=\"left\">POST</td>\n<td align=\"right\">create a new user in db</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>/login</strong></td>\n<td align=\"left\">POST</td>\n<td align=\"right\">authenticate a current user</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>/logout</strong></td>\n<td align=\"left\">GET</td>\n<td align=\"right\">logout page</td>\n</tr>\n</tbody>\n</table>\n<p><code>authRoutes.js</code> 파일을 생성한 후, 다음과 같이 라우터를 설정해 줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// routes/authRoutes.js\r\nconst { Router } = require(&#39;express&#39;);\r\n\r\nconst router = Router();\r\n\r\nrouter.get(&#39;/signup&#39;, () =&gt; {});\r\nrouter.post(&#39;/signup&#39;, () =&gt; {});\r\nrouter.get(&#39;/login&#39;, () =&gt; {});\r\nrouter.post(&#39;/login&#39;, () =&gt; {});\r\nrouter.get(&#39;/logout&#39;, () =&gt; {})\r\n\r\nmodule.exports = router;</code>\n        </deckgo-highlight-code>\n<h3>컨트롤러</h3>\n<p>이제 각각의 기능을 구현할 컨트롤러를 만들어 줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// controllers/authController.js\r\n\r\nmodule.exports.signup_get = (req, res) =&gt; {\r\n\tres.render(&#39;signup&#39;)\r\n}\r\n\r\nmodule.exports.login_get = (req, res) =&gt; {\r\n\tres.render(&#39;login&#39;)\r\n}\r\n\r\nmodule.exports.signup_post = (req, res) =&gt; {\r\n\tres.send(&#39;new signup&#39;)\r\n}\r\n\r\nmodule.exports.login_post = (req, res) =&gt; {\r\n\tres.send(&#39;user login&#39;)\r\n}</code>\n        </deckgo-highlight-code>\n<p>구성한 컨트롤러를 router에 연결합니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// routes/authRoutes.js\r\n\r\nconst {Router} = require(&#39;express&#39;);\r\nconst authController = require(&#39;../controllers/authController&#39;);\r\n\r\nconst router = Router();\r\n\r\nrouter.get(&#39;/signup&#39;, authController.signup_get);\r\nrouter.post(&#39;/signup&#39;, authController.signup_post);\r\nrouter.get(&#39;/login&#39;, () =&gt; authController.login_get);\r\nrouter.post(&#39;/login&#39;, () =&gt; authController.login_post);\r\n\r\n\r\nmodule.exports = router;</code>\n        </deckgo-highlight-code>\n<p><code>app.js</code>에도 이 라우터들을 연결해 줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">...\r\nconst authRoutes = require(&#39;./routes/authRoutes&#39;);\r\n...\r\n\r\napp.use(authRoutes);</code>\n        </deckgo-highlight-code>\n<h2>5. Postman을 이용한 API 테스트</h2>\n<p><a href=\"https://www.postman.com/\">Postman</a>은 프론트엔드가 구현되기 전에 서버에 대한 요청을 시뮬레이션할 수 있는 플랫폼입니다.<br/>\r\n이를 통해 개발한 API를 테스트하고, 테스트 결과를 공유하여 API 개발의 생산성을 높일 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f6d933c1ad2dcad32db2f3e6bacb358e/f9c26/postman.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.26582278481012%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABf0lEQVR42pVSy47UMBDMT3BjFL8dP5I4yTjZeIEs3JA48zH8fKF2dqJBggOHkl3q7nJ1t5uUEuZpgrUW3ntM0wTnHJRSEFJCKgVjDKYxYh4itJLgQoC3N7D0BjkWpGgRNENnDRrvA3xM6Pu+ClXhECofhqFyEpdSQGtV7yc0JLvBGQkTZ4hPPyHDjCbnjLTcsb1s2LYN5DgNA8K76DiO9YGu6y6QY601lLbVsYwZH3/8AusLmnleEKJDKTuO4w3DOMIaDWsN2rYFY6yijkCIi9OdRBnjYO0N+vYBirdoKNE4i7yu2PcdMUZwzmsBnQ/8jVPtyQWEpAclGrLfeYdlWTDPc22Jkh5OCM9CFYzwHmP8yqezClpncc+5OiTR4B1c19WFUPxcirwEafNSK0ianz5/AsXJdaOVge80XtYVpZTqNHhfN26svURpXs/tPsDFyS9BFz1CirjvGeX1Feu61qLnhfyz9Sc8FtXcvxWs3z+jPzK+fD1wHMcfbv4HJPgbj0Mjf3elS8EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Postman\"\n        title=\"\"\n        src=\"/static/f6d933c1ad2dcad32db2f3e6bacb358e/984b6/postman.png\"\n        srcset=\"/static/f6d933c1ad2dcad32db2f3e6bacb358e/4d6f2/postman.png 158w,\n/static/f6d933c1ad2dcad32db2f3e6bacb358e/3c1ae/postman.png 315w,\n/static/f6d933c1ad2dcad32db2f3e6bacb358e/984b6/postman.png 630w,\n/static/f6d933c1ad2dcad32db2f3e6bacb358e/e7d8e/postman.png 945w,\n/static/f6d933c1ad2dcad32db2f3e6bacb358e/58c38/postman.png 1260w,\n/static/f6d933c1ad2dcad32db2f3e6bacb358e/f9c26/postman.png 2880w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Postman을 통해 생성한 api 주소로 각 요청을 보내 연결이 잘 되는지 확인할 수 있습니다.</p>\n<h2>6. model</h2>\n<p><code>mongoose</code>를 통해 유저 정보를 MongoDB에 넣을때, 스키마를 만들어야 합니다.<br/>\r\n스키마란 기본적으로 데이터베이스에서 사용자 데이터나 기록이 어떻게 표시되어야 하는지를 정의합니다.<br/>\r\n해당 파트에서 유효성 문구 등을 직접 설정할 수 있습니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// models/User.js\r\n\r\nconst mongoose = require(&#39;mongoose&#39;);\r\nconst { isEmail } = require(&#39;validator&#39;);\r\n\r\nconst userSchema = new mongoose.Schema({\r\n\temail: {\r\n\t\ttype: String,\r\n\t\trequired: [true, &#39;Please enter an email&#39;],\r\n\t\tunique: true,\r\n\t\tlowercase: true,\r\n\t\tvalidate: [isEmail, &#39;Please enter a valid email&#39;]\r\n\t},\r\n\tpassword: {\r\n\t\ttype: String,\r\n\t\trequired: [true, &#39;Please enter a password&#39;],\r\n\t\tminlength: [6, &#39;Minimum password length is 6 characters&#39;]\r\n\t},\r\n});\r\n\r\nconst User = mongoose.model(&#39;user&#39;, userSchema);\r\n\r\nmodule.exports = User;</code>\n        </deckgo-highlight-code>\n<p>다시 컨트롤러로 돌아가서 유저 모델을 연결해 줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// controllers/authController.js\r\nconst User = require(&#39;../models/User&#39;);\r\n\r\n// handle errors\r\nconst handleErrors = (err) =&gt; {\r\n\tconsole.log(err.message, err.code);\r\n\tlet error = { email: &#39;&#39;, password: &#39;&#39;};\r\n\r\n\t// duplicate error code\r\n\tif (err.code === 11000) {\r\n\t\terrors.email = &#39;that email is aleady registered&#39;;\r\n\t\treturn errors;\r\n\t}\r\n\r\n\t// validation errors\r\n\tif (err.message.includes(&#39;user validation failed&#39;)) {\r\n\t\tObject.values(err.errors).forEach(({properties}) =&gt; {\r\n\t\t\terror[properties.path] = properties.message;\r\n\t\t})\r\n\t}\r\n\r\n\treturn errors;\r\n}\r\n\r\nmodule.exports.signup_get = (req, res) =&gt; {\r\n\tres.render(&#39;signup&#39;)\r\n}\r\n\r\nmodule.exports.login_get = (req, res) =&gt; {\r\n\tres.render(&#39;login&#39;)\r\n}\r\n\r\nmodule.exports.signup_post = async (req, res) =&gt; {\r\n\tconst {email, password} = req.body;\r\n\r\n\ttry {\r\n\t\tconst user = await User.create({ email, password }); // 유저 생성\r\n\t\tres.status(201).json(user);\r\n\t}\r\n\tcatch (err) {\r\n\t\tconst errors = handleErrors(err);\r\n\t\tres.status(400).json({errors})\r\n\t}\r\n}\r\n\r\nmodule.exports.login_post = async (req, res) =&gt; {\r\n\tconst {email, password} = req.body;\r\n\r\n\tconsole.log(email, password);\r\n\tres.send(&#39;user login&#39;)\r\n}</code>\n        </deckgo-highlight-code>\n<h3>비밀번호 해시처리</h3>\n<p>현재 유저정보가 DB에 잘 쌓이고 있는데, 비밀번호가 그대로 드러나고 있습니다.<br/>\r\n이를 방지하기 위해, <code>bcrypt</code> 라이브러리를 사용하여 비밀번호를 암호화 시켜줍니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// User.js\r\n\r\nconst mongoose = require(&#39;mongoose&#39;);\r\nconst { isEmail } = require(&#39;validator&#39;);\r\nconst bcrypt = require(&#39;bcrypt&#39;);\r\n\r\nconst userSchema = new mongoose.Schema({\r\n\temail: {\r\n\t\ttype: String,\r\n\t\trequired: [true, &#39;Please enter an email&#39;],\r\n\t\tunique: true,\r\n\t\tlowercase: true,\r\n\t\tvalidate: [isEmail, &#39;Please enter a valid email&#39;]\r\n\t},\r\n\tpassword: {\r\n\t\ttype: String,\r\n\t\trequired: [true, &#39;Please enter a password&#39;],\r\n\t\tminlength: [6, &#39;Minimum password length is 6 characters&#39;]\r\n\t},\r\n});\r\n\r\n// fire a function before doc saved to db\r\nuserSchema.pre(&#39;save&#39;, async function (next) {\r\n\tconst salt = await bcrypt.genSalt();\r\n\tthis.password = await bcrypt.hash(this.password, salt);\r\n\t\r\n\tnext();\r\n})\r\n\r\nconst User = mongoose.model(&#39;user&#39;, userSchema);\r\n\r\nmodule.exports = User;</code>\n        </deckgo-highlight-code>\n<p>데이터가 저장되기 전에(<code>pre</code>) 비밀번호를 해시 처리해서 암호화 시켜줍니다.</p>\n<h3>Cookies</h3>\n<p>쿠키는 클라이언트 개개인의 상태 정보를 담고 있는 데이터입니다.<br/>\r\n다음과 같은 방법으로 브라우저에 쿠키를 생성할 수 있습니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// app.js\r\n\r\n// cookies\r\napp.get(&#39;/set-cookies&#39;, (req, res) =&gt; {\r\n\tres.setHeader(&#39;Set-Cookie&#39;, &#39;newUser=true&#39;);\r\n\t// 또는\r\n\tres.cookie(&#39;newUser&#39;, false);\r\n\t\r\n\tres.send(&#39;you got the cookies!&#39;);\r\n});</code>\n        </deckgo-highlight-code>\n<blockquote>\n<p>💡 여기서 주의할 점!</p>\n<p>쿠키는 javascript의 document.cookie를 통해 접근할 수 있기 때문에, 해킹 당할 위험이 있다.\r\n이를 보호하기 위해 HttOnly나 Secure 속성을 설정할 수 있다.</p>\n</blockquote>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">res.cookie(&#39;test&#39;, true, { httpOnly: true })</code>\n        </deckgo-highlight-code>\n<p>이렇게 httpOnly 옵션을 추가하면, 클라이언트의 환경(웹 브라우저)에서 스크립트(javascript 등)로 쿠키에 접근하는 것을 차단할 수 있다. 이 설정을 함으로써 XSS(Cross Site Script) 공격에 대응이 가능하다.</p>\n<p>추가로, 쿠키의 만료날짜를 설정할 수 있습니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">const maxAge = 60 * 60 * 24 * 2;  // 60초 * 60분 * 24시간 * 2일\r\n\r\nres.cookie(&#39;jwt&#39;, token, { httpOnly: true, maxAge: maxAge * 1000 })</code>\n        </deckgo-highlight-code>\n<h2>7. JSON Web Tokens</h2>\n<p>JWT(JSON Web Token)란 <strong>인증에 필요한 정보들을 암호화시킨 JSON 토큰</strong>을 의미합니다.<br/>\r\n그리고 JWT 기반 인증은 JWT 토큰(Access Token)을 HTTP 헤더에 실어 서버가 클라이언트를 식별하는 방식입니다.<br/>\r\nJWT는 .을 구분자로 나누어지는 세 가지 문자열의 조합입니다.<br/>\r\n.을 기준으로 <code>Header</code>, <code>Payload</code>, <code>Signature</code>로 구성되어 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a688b3536a0be435f268132ae32083a2/7e08f/jsonwebtoken.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVR42mWS204bMRBA+RhYjz2+7C3XTUIpIoQgQi5tIpUi9f9/4lTetISqD2dn5ZGPPeO5KsTxlxtxXIv9FM9c8vlfKaynsHrm0/7MVf6YP4KRSfwsOnZmzFsxZS1jHsKOlT+c0T3taku7OzE8vNFujkhquCnkX+H5RlmsrM2Qb2bC1owZ2Mg0PLAOJ+7Dhqne4b8uqQ+/KDcn0tOeQgPXxlyEWWZFiaJ4sSSjVOJJ4vHGEiUxkI5GRpSmxZuKpBOitERpiFITpMaI58ZYrnKppSRe3TObnnXPzr2wtU/Mxs9MZyduZ2/cdj/ouiOL6Yl5ZrRnMT3SDXdYCX2Pzz3UQOUbWh1QaoMLFdaXJD+mSh0xjZBYUsRA4T2mTEg7PFM3mOAR9eeSjVV8LJlpw522jLQiphrrPcM440taMYm3eF8SywoNJWEwo75/JU3v8NUAmx2hJLt6ofORoSQ6qZhIiQuR4GpGuqDVjrkuGegcq0pcrKhf3ilXR8L8kbBYYasRLlYXodXAoIjMTEljAoXmB6p58Fse/Z5teKeyY4wV3HBBevxOXB5IywNh8YQJNdaFi1B9xKjnRn0fNaS+xHyQ04TT2Pcol5Vvktetj30UI1iXq0yXOcwTb/7D9RR/+FgX95E74z9yeWx+AxitWTHNxlT2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jsonwebtoken\"\n        title=\"\"\n        src=\"/static/a688b3536a0be435f268132ae32083a2/984b6/jsonwebtoken.png\"\n        srcset=\"/static/a688b3536a0be435f268132ae32083a2/4d6f2/jsonwebtoken.png 158w,\n/static/a688b3536a0be435f268132ae32083a2/3c1ae/jsonwebtoken.png 315w,\n/static/a688b3536a0be435f268132ae32083a2/984b6/jsonwebtoken.png 630w,\n/static/a688b3536a0be435f268132ae32083a2/e7d8e/jsonwebtoken.png 945w,\n/static/a688b3536a0be435f268132ae32083a2/7e08f/jsonwebtoken.png 1186w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code>Header</code> 에는 JWT 에서 사용할 타입과 해시 알고리즘의 종류가 담겨있으며, <code>Payload</code> 는 서버에서 첨부한 사용자 권한 정보와 데이터가 담겨있습니다. <code>Signature</code>에는 Header, Payload 를 Base64 URL-safe Encode를 한 이후 Header에 명시된 해시함수를 적용하고, 개인키(Private Key)로 서명한 전자서명이 담겨있습니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// controllers/authController.js\r\n...\r\nconst jwt = require(&#39;jsonwebtoken&#39;);\r\n...\r\n\r\nconst maxAge = 3 * 24 * 60 * 60;  // three days\r\nconst createToken = (id) =&gt; {\r\n\treturn jwt.sign({ id }, config.secret, {\r\n\t\texpiresIn: maxAge\r\n\t});\r\n} \r\n\r\n...\r\n\r\nmodule.exports.signup_post = async (req, res) =&gt; {\r\n\tconst {email, password} = req.body;\r\n\r\n\ttry {\r\n\t\tconst user = await User.create({ email, password });\r\n\t\tconst token = createToken(user._id);\r\n\t\tres.cookie(&#39;jwt&#39;, token, { httpOnly: true, maxAge: maxAge * 1000 })\r\n\t\tres.status(201).json({ user: user._id });\r\n\t}\r\n\tcatch (err) {\r\n\t\tconst errors = handleErrors(err);\r\n\t\tres.status(400).json({errors})\r\n\t}\r\n}\r\n...</code>\n        </deckgo-highlight-code>\n<h3>JWT를 이용한 인증 과정</h3>\n<ol>\n<li>사용자가 ID, PW를 입력하여 서버에 로그인 인증을 요청한다.</li>\n<li>서버에서 클라이언트로부터 인증 요청을 받으면, Header, PayLoad, Signature를 정의한다.Hedaer, PayLoad, Signature를 각각 Base64로 한 번 더 암호화하여 JWT를 생성하고 이를 쿠키에 담아 클라이언트에게 발급한다.</li>\n<li>클라이언트는 서버로부터 받은 JWT를 로컬 스토리지에 저장한다. (쿠키나 다른 곳에 저장할 수도 있음)API를 서버에 요청할때 <strong>Authorization header에 Access Token을 담아</strong>서 보낸다.</li>\n<li>서버가 할 일은 클라이언트가 Header에 담아서 보낸 JWT가 내 서버에서 발행한 토큰인지 일치 여부를 확인하여 일치한다면 인증을 통과시켜주고 아니라면 통과시키지 않으면 된다.인증이 통과되었으므로 페이로드에 들어있는 유저의 정보들을 select해서 클라이언트에 돌려준다.</li>\n<li>클라이언트가 서버에 요청을 했는데, 만일 액세스 토큰의 시간이 만료되면 클라이언트는 리프래시 토큰을 이용해서</li>\n<li>서버로부터 새로운 엑세스 토큰을 발급 받는다.</li>\n</ol>\n<h3>라우트 보호하기</h3>\n<p>요청에 jwt가 있는지 확인하고, jwt가 문제가 없는지 확인하는 과정입니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// middleware/authMiddleware.js\r\n\r\nconst jwt = require(&#39;jsonwebtoken&#39;);\r\n\r\nconst config = require(&#39;../config.js&#39;);\r\n\r\nconst requireAuth = (req, res, next) =&gt; {\r\n\tconst token = req.cookies.jwt;\r\n\t\r\n\t// check json web token exists &amp; is verified\r\n\tif (token) {\r\n\t\tjwt.verify(token, config.secret, (err, decodedToken) =&gt; {\r\n\t\t\tif (err) {\r\n\t\t\t\tconsole.log(err.message);\r\n\t\t\t\tres.redirect(&#39;/login&#39;);\r\n\t\t\t} else {\r\n\t\t\t\tconsole.log(decodedToken);\r\n\t\t\t\tnext();\r\n\t\t\t}\r\n\t\t})\r\n\t} else {\r\n\t\tres.redirect(&#39;/login&#39;);\r\n\t}\r\n}\r\n\r\nmodule.exports = { requireAuth }</code>\n        </deckgo-highlight-code>\n<p>jwt 토큰이 없거나, 유효하지 않은 경우 login 페이지로 넘어가도록 리다이렉트 해 줍니다.</p>\n<p>유효한 토큰이 있는 경우에만 접근할 수 있는 페이지에 해당 middleware를 추가합니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// app.js\r\n\r\napp.get(&#39;/home&#39;, requireAuth, (req, res) =&gt; res.render(&#39;home&#39;));</code>\n        </deckgo-highlight-code>\n<h2>8. 로그아웃</h2>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// AuthController.js\r\n\r\nmodule.exports.logout_get = (req, res) =&gt; {\r\n\tres.cookie(&#39;jwt&#39;, &#39;&#39;, { maxAge: 1 });\r\n\tres.redirect(&#39;/&#39;);\r\n}</code>\n        </deckgo-highlight-code>\n<p>로그아웃은 controller에서 jwt라는 키를 가진 쿠키를 지워줍니다.</p>\n<h3>현재 유저 확인</h3>\n<p>ejs는 서버로부터 받은 데이터를 가공하여 클라이언트에서 사용할 수 있습니다.</p>\n<p>이를 위해 변수를 초기화하는 미들웨어를 작성합니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// authMiddleware.js\r\n\r\n...\r\n\r\n//check current user\r\nconst checkUser = (req, res, next) =&gt; {\r\n\tconst token = req.cookies.jwt;\r\n\t\r\n\tif (token) {\r\n\t\tjwt.verify(token, config.secret, async (err, decodedToken) =&gt; {\r\n\t\t\tif (err) {\r\n\t\t\t\tconsole.log(err.message);\r\n\t\t\t\tres.locals.user = null;\r\n\t\t\t\tnext();\r\n\t\t\t} else {\r\n\t\t\t\tconsole.log(decodedToken);\r\n\t\t\t\tlet user = await User.findById(decodedToken.id);\r\n\t\t\t\tres.locals.user = user;\r\n\t\t\t\tnext();\r\n\t\t\t}\r\n\t\t})\r\n\t} else {\r\n\t\tres.locals.user = null;\r\n\t\tnext();\r\n\t}\r\n}\r\n\r\nmodule.exports = {requireAuth, checkUser};</code>\n        </deckgo-highlight-code>\n<p><code>res.locals.[variable]</code> 을 통해 클라이언트에 변수를 전달할 수 있습니다.</p>\n<deckgo-highlight-code language=\"js\"  >\n          <code slot=\"code\">// app.js\r\nconst { requireAuth, checkUser } = require(&#39;./middleware/authMiddleware&#39;);\r\n\r\n...\r\napp.get(&#39;*&#39;, checkUser); // every single get request\r\n...</code>\n        </deckgo-highlight-code>\n<p>app.js에 checkUser를 가져와 모든(<code>*</code>) get request에서 현재 유저를 확인하는 코드를 추가합니다.</p>\n<p>여기서 생긴 궁금증!</p>\n<h3>middleware란 무엇인가?</h3>\n<blockquote>\n<p>middleware의 사전적 정의</p>\n<p>미들웨어는 양 쪽을 연결하여 데이터를 주고 받을 수 있도록 중간에서 매개 역할을 하는 소프트웨어, 네트워크를 통해서 연결된 여러 개의 컴퓨터에 있는 많은 프로세스들에게 어떤 서비스를 사용할 수 있도록 연결해 주는 소프트웨어를 말한다. 3계층 클라이언트/서버 구조에서 미들웨어가 존재한다. 웹 브라우저에서 데이터베이스로부터 데이터를 저장하거나 읽어올 수 있게 중간에 미들웨어가 존재하게 된다.</p>\n</blockquote>\n<p>광범위한 설명이지만 다음 2개의 키워드가 미들웨어의 역할이라고 생각합니다.</p>\n<ol>\n<li>양쪽을 연결</li>\n<li>중간에서의 매개 역할</li>\n</ol>\n<p>큰 범위로 보면 매개체 간 연결해주는 레이어로써, 매개체는 클라이언트(사용자) - 서버, 서버 - 서버 간의 통신이 될 수도 있습니다.<br/>\r\n통상적으로 기업에서 말하는 미들웨어 환경은 웹/어플리케이션 서버를 의미합니다.</p>\n<p>ejs 템플릿을 사용한 프론트 단은 따로 내용에 작성하지 않았습니다.</p>\n<p>모든 코드는 <a href=\"https://github.com/kirahaa/auth-with-jwt\">github 레포지토리</a> 참고 부탁드립니다.</p>\n<hr>\n<p>여기까지, JWT 인증 시스템 구현이 끝났습니다!<br/>\r\nJWT 인증은 해도 해도 어려운 것 같아요😥 다음에는 REACT 환경에서 JWT 인증을 구현해 보는 것도 도전해 보기로!</p>\n<p>다음 포스팅에서는 AWS 프리티어를 이용해서 웹 호스팅 서버를 만드는 과정을 살펴보겠습니다.</p>\n<p>가보자고~!💨</p>\n<hr>\n<h4>참고 자료</h4>\n<ul>\n<li>\n<p><a href=\"https://www.youtube.com/watch?v=SnoAwLP1a-0&#x26;list=PL4cUxeGkcC9iqqESP8335DA5cRFp8loyp\">https://www.youtube.com/watch?v=SnoAwLP1a-0&#x26;list=PL4cUxeGkcC9iqqESP8335DA5cRFp8loyp</a></p>\n</li>\n<li>\n<p><a href=\"https://velopert.com/2448\">https://velopert.com/2448</a></p>\n</li>\n<li>\n<p><a href=\"https://inpa.tistory.com/entry/WEB-%F0%9F%93%9A-JWTjson-web-token-%EB%9E%80-%F0%9F%92%AF-%EC%A0%95%EB%A6%AC\">https://inpa.tistory.com/entry/WEB-📚-JWTjson-web-token-란-💯-정리</a></p>\n</li>\n<li>\n<p><a href=\"https://www.daleseo.com/js-jwt/\">https://www.daleseo.com/js-jwt/</a></p>\n</li>\n</ul>","frontmatter":{"title":"Node.js + Express + JWT 인증 시스템 구현하기(feat. MongoDB)","date":"July 14, 2023","description":"Node.js와 Express, Mongodb를 이용한 JWT 토큰 기반 인증 시스템을 구현 한 뒤, AWS ec2를 통해 배포한 내용을 정리하였습니다.","tags":["Node.js","Express","JWT","Auth"]}},"previous":{"fields":{"slug":"/custom-gatsby-blog/"},"frontmatter":{"title":"Gatsby 블로그 꾸미기"}},"next":{"fields":{"slug":"/aws-ec2-hosting/"},"frontmatter":{"title":"AWS 프리티어 EC2와 Github 연동하기"}}},"pageContext":{"id":"b54a6070-dbd7-5ce7-ac9c-21d9aad67db7","previousPostId":"6f17cd8f-fbaa-5195-a916-c16af7bc28d7","nextPostId":"1403beec-17fa-5740-bb74-db292102feab"}},"staticQueryHashes":["2837417301","2841359383"],"slicesMap":{}}